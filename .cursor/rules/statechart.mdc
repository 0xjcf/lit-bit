---
description: 
globs: 
alwaysApply: true
---
# Rustâ€‘Statechart Â· Development Rules

> **Purpose** â€” Serve as a single sourceâ€‘ofâ€‘truth for contributors (human or AI) working in Cursor IDE.
> Compliant code **must** satisfy every rule or provide an issue reference that justifies a deviation.

---

## 0 Â· Meta

* **File owner:** @0xjcf
* **Roadmap ref:** [v0.1 Roadmap Table](mdc:insert link to roadmap doc)
* **Enforced by:** `.github/workflows/check_rules.yml` (lint job parses this file and fails if unchecked items remain in a merged PR).

---

## 1 Â· Phase Completion Checklist

> Tick **all** boxes **before** closing a phase milestone GitHub issue.

| Phase                  | Key Deliverables                                                              | Done |
| ---------------------- | ----------------------------------------------------------------------------- | ---- |
| 0 Spec & Foundations   | â–¢ Spec.md committed  â–¢ CI skeleton âœ…                                          |   â–¢  |
| 1 Core Runtime         | â–¢ `traffic_light` demo on riscv32  â–¢ â‰¤1 KB flash report  â–¢ 100 % unitâ€‘tests  | â–¢    |
| 2 Hierarchy & Guards   | â–¢ Parent/child exit order tests  â–¢ Unknownâ€‘state compile error unitâ€‘test      | â–¢    |
| 3 Parallel States      | â–¢ `agent_parallel` golden trace  â–¢ Memory diff â‰¤+200 B                        | â–¢    |
| 4 Minimal Actor Layer  | â–¢ `Actor` generic no_std  â–¢ Tokio adapter  â–¢ Stressâ€‘test passes 100 k events | â–¢    |
| 5 Async & Sideâ€‘Effects | â–¢ `async` feature flag compile check  â–¢ HTTP demo passes                      | â–¢    |
| 6 Timers & Delays      | â–¢ `after` syntax macro  â–¢ Embedded drift test <1 %                            | â–¢    |
| 7 Invoke/Child Actors  | â–¢ Restart policy test  â–¢ Parentâ€child demo                                    | â–¢    |
| 8 Diagram Generation   | â–¢ `to_dot()` output roundâ€‘trips via Graphviz  â–¢ Docs include Mermaid          | â–¢    |
| 9 Tooling & Docs       | â–¢ mdBook CI publish  â–¢ 95 % rustdoc coverage                                  | â–¢    |
| 10 Public Release      | â–¢ CHANGELOG  â–¢ SemVer tag  â–¢ Blog post  â–¢ CI matrix green                     | â–¢    |

Add a checked box (`[x]`) via PR when finished.

---

### Milestone rhythm

* **2â€“3 weeks per phase** for core engineering phases (1-7).
* **Continuous examples & tests** after each phase land.
* **Community beta** after Phase 8 (diagram tooling).

### Success KPIs _(target by v0.1)_

| KPI                                   | Target |
| ------------------------------------- | ----------------------------------- |
| Code size (no_std, Cortex-M0 blinky) | â‰¤ 4 KB flash |
| Max RAM overhead                      | â‰¤ 512 B for single actor, N=8 queue |
| Throughput (Tokio, release)           | â‰¥ 1 M events/s single-thread |
| Compile-time error clarity            | 90 % unknown-state mistakes explained in â‰¤3 lines |
| Docs coverage                         | â‰¥ 95 % rustdoc |
| CI matrix passes                      | Stable, beta, nightly; Linux, macOS, Windows |

---

## 2 Â· Coding Standards

1. **Zeroâ€‘Cost Core**

   * `#![no_std]` **default**. `std` is optâ€‘in via feature flag.
   * Absolutely **no heap** in Phase 1â€‘3 paths. Use `heapless` or const data.
2. **Feature Flags**

   * `async` â€“ pulls `alloc`, `futures`, `asyncâ€‘trait`.
   * `std` â€“ enables Tokio mailbox and file I/O.
   * `diagram` â€“ emits `TRANSITIONS` table + formatters; off in firmware builds.
3. **Naming**

   * Enums: `FooState`, `FooEvent`.
   * Traits: `StateMachine`, `Mailbox`, `Actor`.
   * Macros: `statechart!` (lowerâ€‘snake with bang!).
4. **Error Handling**

   * Compileâ€‘time errors for: unknown state, duplicate transition, unreachable region, invalid `[parallel]` nesting.
   * Runtime `panic!` only allowed in `debug_assertions`; release must return `Err`.
5. **Style**

   * `rustfmt.toml` checked in repo â€‘ **CI fails** on diff.
   * Clippy `pedantic` + selected `restriction` lints; exceptions need `#[allow]` + comment.

---

## 3 Â· Macro Grammar (Frozen after Phase 0)

_(Note: The grammar defined in `Spec.md` Section 2 is now considered stable for v0.1 and frozen as of the end of Phase 0. Any breaking changes require a major version bump.)_

```ebnf
// Note: This EBNF is a simplified reference.
// See Spec.md Section 2 for the definitive grammar.
statechart    ::= 'statechart!' '{' header_field+ state_definition* '}'
header_field  ::= 'name:' IDENT ',' | 'initial:' IDENT ',' | 'context:' TYPE ','
state_definition ::= 'state' IDENT state_attributes? '{' state_body_item* '}'
state_body_item  ::= 'on' EVENT '=>' STATE | 'after' DURATION '=>' STATE | ...
```

Any breaking grammar change after Phase 0 requires **major version bump**.

---

## 4 Â· Actor Layer Rules

* **Singleâ€‘threaded guarantee**: internal loop must `await` each handler **before** dequeuing next event.
* **Backâ€‘pressure**: `try_send` returns `Err(evt)` when mailbox full; server side may provide `send().await`.
* **No global alloc** on no_std path; queue uses `heapless::spsc::Queue`.
* **Instrumentation hooks**: behind `trace` feature, call `on_transition(old, evt, new)` so users can hook logging.

---

## 5 Â· Diagram & Doc Rules

* `state_machine.to_dot()` **must** output valid DOT accepted by Graphviz â‰¥ 2.46.
* Mermaid output must render in GitHub MD preview.
* Each public example crate contains a `diagram.svg` committed (generated via CI job on commit).

---

## 6 Â· Testing & CI Matrix

* **Coverage**: `cargo tarpaulin --skip-clean` â‰¥ 90 % lines on `x86_64-unknown-linux-gnu`.
* **Build targets**: `thumbv6m-none-eabi`, `riscv32imac-unknown-none-elf`, `x86_64`, `wasm32-unknown-unknown`.
* **Size check**: `cargo bloat --release --no-default-features` < 4 KB for `blinky` binary.
* **Fuzzing**: quickcheck fuzz on event sequences (Phase 3+).

---

## 7 Â· Release Criteria (v0.1)

* All roadmap boxes checked.
* `README` shields: CI âœ“, `no_std` âœ“, codecov %, Crates.io version.
* `cargo audit` & `cargo deny` clean.
* API stability announced (macro grammar frozen until 0.2).
* First external crate (`statechart-embassy-demo`) compiles against release.

---

## 8 Â· Adding New Features (Postâ€‘v0.1)

1. Open **RFC issue** with motivation & design sketch.
2. Get ðŸ‘ from @0xjcf + one contributor.
3. Land behind `unstableâ€‘<feature>` flag.
4. After two minor versions with no breaking feedback, mark stable.

---

**Remember:** *Small, verifiable increments beat bigâ€‘bang rewrites.* Follow this rule file and the roadmapâ€”we'll ship a goldâ€‘standard, XStateâ€‘grade library that delights both embedded and backend Rustaceans.

